#!/usr/bin/env bash

set -euo pipefail

source script/env "$@"

echo -e "${BLUE}ðŸ¥¾ Bootstrapping...${OFF}"

if [[ "$(uname -s)" != "Darwin" ]]; then
  echo -e "${YELLOW}Skipping bootstrap on non-macOS host.${OFF}"
  exit 0
fi

if ! xcode-select -p >/dev/null 2>&1; then
  echo -e "${RED}Xcode Command Line Tools not found.${OFF}"
  echo "Run: xcode-select --install"
  exit 1
fi

if ! command -v brew >/dev/null 2>&1; then
  echo -e "${RED}Homebrew not found.${OFF}"
  echo "Install from https://brew.sh/"
  exit 1
fi

export HOMEBREW_NO_AUTO_UPDATE=1
export HOMEBREW_NO_INSTALL_CLEANUP=1

deps=(
  xcodegen
  swiftlint
  swiftformat
)

for dep in "${deps[@]}"; do
  if brew list --formula "$dep" >/dev/null 2>&1; then
    echo -e "${GREEN}OK${OFF} - $dep"
  else
    echo -e "${BLUE}Installing${OFF} - $dep"
    brew install "$dep"
  fi
done

if [[ -f "$DIR/project.yml" ]]; then
  echo -e "${BLUE}Generating Xcode project...${OFF}"
  (cd "$DIR" && xcodegen generate)
else
  echo -e "${YELLOW}project.yml not found; skipping XcodeGen.${OFF}"
fi

echo -e "${GREEN}âœ… Bootstrap complete!${OFF}"
